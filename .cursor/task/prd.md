# Flowith 风格流式聊天应用 PRD（MVP 调研版）

## Product overview

- 文档版本：v1.0
- 目标：基于 flowith 的产品理念，输出一份包含产品核心功能、用户交互方式、用户故事与产品卖点的产品调研与最小可行产品（MVP）需求文档，指导前端实现与项目拆解。
- 产品摘要：本工具以「无限画布 + 多节点流式生成」为核心交互，用户可在单一画布中创建多个聊天节点（连接多个 LLM），通过连线表达上下游依赖，进行并行与分叉式创作；支持 Prompt 可编辑复用、结果对比、局部重试与导出。

## Goals

- 业务目标
  - 降低多模型对比、内容迭代与多线程创作门槛，提升 2-3 倍创作效率。
  - 以单机客户端/纯前端（无后端）方案快速验证产品可用性与留存。
  - 构建可扩展的画布交互内核，为后续模板、协作与生态扩展打基础。
- 用户目标
  - 在一个画布中与多个 AI 节点同时交互，快速分叉、汇总、复用内容。
  - 以所见即所得的方式管理上下文与依赖，灵活回溯、重试与导出。
- 非目标（MVP 不做）
  - 账号系统/云同步/多人实时协作。
  - 复杂权限模型、团队空间与私有化部署。
  - 自建后端推理与计费系统。

## User personas

- 个人创作者：写作、视频脚本、社媒运营；关注易用性、效率与导出。
- 产品/研发：方案比对、Prompt 迭代；关注结构化、可追溯与复现。
- 学术/学习者：多来源整合、摘要与笔记；关注引用与知识沉淀。
- 角色与访问（MVP）
  - 单用户本地使用；通过本地安全存储 API Key 访问外部 LLM。

## Functional requirements（含优先级）

- 画布与节点（P0）
  - 创建/移动/缩放画布，网格背景与吸附对齐。
  - 自定义聊天节点（标题、模型、提示词、消息区、运行/停止/复制/删除）。
  - 连线（输出→输入），校验循环依赖，支持多入单出。
  - 节点状态：idle/running/success/error；运行中可中止；错误可重试。
- 运行与上下文（P0）
  - 节点内输入 Prompt，⌘/Ctrl+Enter 运行；读取上游节点最近输出作为上下文。
  - 消息以 Markdown 渲染（P1 可做虚拟化）。
- 项目与存储（P0）
  - 新建/打开/保存项目（本地 IndexedDB 或文件）；保存当前画布状态。
  - 设置页：输入 API Key、默认模型、语言；本地加密存储。
- 导入与导出（P1）
  - 导出 PNG、Markdown、JSON；导入 JSON 恢复画布。
- 辅助能力（P1）
  - 迷你地图、缩放控制、命令面板、模板库。
- 快捷键与 A11y（P0）
  - N 新建节点、⌘/Ctrl+Enter 运行、⌘/Ctrl+D 复制、Delete 删除、撤销/重做。
  - 节点可聚焦，按钮具名 aria-label；满足 WCAG AA 颜色对比。

## User experience

- 进入方式：
  - 打开应用进入项目中心 → 新建/打开项目 → 进入画布。
  - 任意时刻通过设置入口配置 API Key/默认模型。
- 核心流程：
  - 新建「聊天节点」→ 输入 Prompt → 运行 → 查看输出。
  - 连接节点形成流水线；上游输出自动作为下游上下文；可分叉对比。
  - 复制/删除/重命名节点；失败后 Retry；必要时 Stop。
- 进阶能力：
  - 多节点并行运行；对比不同模型效果；导出结果；应用模板。
- UI/UX 要点：
  - 暗亮主题预留；卡片化节点、圆角与轻投影；状态动效不超过 3 次/秒。
  - 右侧属性面板（P1）显示所选节点属性与模型参数。

## Narrative（用户视角）

我打开画布，新建了 3 个聊天节点，分别设置不同模型与提示词。我把第一个节点的结果接到第二个节点做润色，再把第三个节点分叉改写不同风格。运行后我一眼就能对比各路输出，不满意的节点我直接修改 Prompt 重试，满意的结果我导出为 Markdown 备份，下次打开还能恢复到同样的画布状态继续创作。

## Success metrics

- 用户：首次 15 分钟内完成「创建→连线→运行→保存」闭环；任务完成时间较单线对话缩短 ≥40%。
- 业务：次周留存 ≥25%；项目导出功能使用率 ≥30%。
- 技术：主线程掉帧 < 16ms/帧（常规操作）；大画布 100+ 节点仍可流畅拖拽；关键交互 200ms 内反馈。

## Technical considerations（前端架构与技术选型）

- 技术栈
  - React 19 + Vite + TypeScript
  - React Flow（@xyflow/react）用于画布/连线/节点系统
  - Zustand 进行全局状态管理（持久化 + Devtools）
  - Tailwind CSS 4 + shadcn/ui 风格化基础组件
  - 本地存储：IndexedDB（持久化项目）+ WebCrypto（API Key 加密）
- 目录与模块（建议）
  - pages：`ProjectHubPage`、`CanvasPage`、`SettingsModal`
  - components：`TopBar`、`LeftToolbar`、`RightPanel`、`ChatNode`、`MiniMap`
  - state：Zustand 切片（project/canvas/nodes/edges/runtime/settings/ui/templates）
  - services：`llmClient`、`storage`、`crypto`、`export`
  - hooks：`useRunNode`、`useHotkeys`
- 关键设计
  - 节点数据模型：`ChatNodeData { title, modelId, prompt, messages[], status, error? }`
  - 运行桥接：`useRunNode` 将节点数据映射为 LLM 请求，写回 messages/status。
  - 循环校验：`validateNoCycle(source, target)` 防止自回路。
  - 性能：选择器拆分、事件去抖、内容分层渲染、长列表虚拟化（P1）。
  - 无后端：通过用户 API Key 直接调用 OpenAI 兼容接口；未来可切换服务端代理。

## Milestones & sequencing（项目拆解）

- 里程碑 A（P0，2 周，2 人）
  - AppShell/TopBar/Canvas 基础搭建；注册 `ChatNode`；连线与运行最小闭环。
  - Zustand 核心切片与持久化；设置页（API Key/默认模型）。
  - 新建/打开/保存项目；快捷键与基础 A11y；错误分类与重试。
- 里程碑 B（P1，2-3 周）
  - 迷你地图与控制、Markdown 渲染与导出、模板应用、消息虚拟化。
- 里程碑 C（P2，3-4 周）
  - 并发运行队列、任务中断、主题切换、版本快照、命令面板、全文搜索。

## User stories（含验收标准）

- US-001｜创建聊天节点
  - 描述：用户可以在画布中心创建一个默认尺寸的聊天节点。
  - 验收：点击左栏按钮或按 N，出现 1 个 M 尺寸节点，默认 idle，可拖拽。
- US-002｜节点连线（防循环）
  - 描述：从一个节点输出端口拖到另一个节点输入端口建立连接，禁止形成环。
  - 验收：成功建立单条边；若检测到环则提示并阻止；多入单出生效。
- US-003｜运行与停止
  - 描述：在节点内输入 Prompt，可运行并在过程中停止。
  - 验收：⌘/Ctrl+Enter 或 Run 按钮触发 running；显示进度样式；Stop 将状态恢复 idle。
- US-004｜结果与 Markdown 渲染
  - 描述：节点输出以消息形式显示，并支持基础 Markdown 渲染。
  - 验收：运行成功后新增 assistant 消息；代码块/列表正确渲染（P1 完整）。
- US-005｜错误与重试
  - 描述：请求失败显示错误条并可一键重试。
  - 验收：显示错误原因（如 401/429）；点击 Retry 后可重新进入 running。
- US-006｜复制与删除节点
  - 描述：支持复制当前节点或删除选中节点。
  - 验收：⌘/Ctrl+D 复制生成同配置节点；Delete 删除并更新边与选择状态。
- US-007｜保存与打开项目
  - 描述：将当前画布与节点状态保存本地并可再次打开。
  - 验收：保存后刷新仍可还原；打开历史项目能恢复节点/边/视图。
- US-008｜导出 PNG/Markdown/JSON（P1）
  - 描述：导出画布为图片、导出消息为 Markdown、导出结构为 JSON。
  - 验收：生成对应文件并包含当前视图或数据；导入 JSON 可恢复。
- US-009｜设置 API Key 与默认模型
  - 描述：通过设置页配置 API Key（本地加密）与默认模型。
  - 验收：密钥加密保存；调用时正常读取；可更新或清除。
- US-010｜快捷键与可访问性
  - 描述：支持 N/运行/复制/删除/撤销/重做等快捷键；节点可通过键盘操作。
  - 验收：快捷键在聚焦画布时生效；Tab 可聚焦节点与操作按钮，aria 标签齐全。
- US-011｜多模型对比（并行运行）
  - 描述：在同一画布并行运行多个节点以对比输出质量。
  - 验收：两个以上节点同时 running 不互相阻塞；完成后状态分别更新。
- US-012｜分叉与引用（P1）
  - 描述：下游节点引用上游最近一次输出作为上下文，支持分叉多路。
  - 验收：建立连接后运行，下游 messages 包含上游最新输出片段或引用标记。
- US-013｜安全与权限（本地）
  - 描述：仅本地单用户，API Key 不上传服务端；跨域请求仅指向官方或可配置代理。
  - 验收：网络面板无密钥泄漏；密钥以加密形式存在本地存储。
